<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE data SYSTEM "../dtd/xmldata.dtd">

<!--
  * 2.1.1_update.xml
  *
  * Copyright (c) 2000-2008 John Willinsky
  * Distributed under the GNU GPL v2. For full terms see the file docs/COPYING.
  *
  * 2.1.1 database updates XML file.
  *
  * $Id$
  -->

<data>
	<!-- Bug #3607: User settings primary key needs to include conference id -->
	<sql>
		<!-- Syntax for MySQL. -->
		<query driver="mysql">
			UPDATE user_settings SET conference_id = 0 WHERE conference_id IS NULL
		</query>
		<query driver="mysql">
			ALTER TABLE user_settings CHANGE COLUMN conference_id conference_id BIGINT NOT NULL DEFAULT 0
		</query>
		<query driver="mysql">
			ALTER TABLE user_settings DROP INDEX user_settings_pkey, ADD INDEX user_settings_pkey (user_id, locale, setting_name, conference_id) 
		</query>

		<!-- Syntax for PostgreSQL. -->
		<query driver="postgres7">
			UPDATE user_settings SET conference_id = 0 WHERE conference_id IS NULL
		</query>
		<query driver="postgres7">
			ALTER TABLE user_settings ALTER COLUMN conference_id SET NOT NULL
		</query>
		<query driver="postgres7">
			ALTER TABLE user_settings ALTER COLUMN conference_id SET DEFAULT 0 
		</query>
		<query driver="postgres7">
			DROP INDEX user_settings_pkey
		</query>
		<query driver="postgres7">
			CREATE UNIQUE INDEX user_settings_pkey ON user_settings (user_id, locale, setting_name, conference_id)
		</query>
	</sql>

	<!-- Bug #3293: Enable user comments on a per track/paper basis -->
	<sql>
		<!-- Syntax for MySQL. -->
		<query driver="mysql">
			ALTER TABLE tracks ADD COLUMN disable_comments TINYINT NOT NULL DEFAULT 0
		</query>
		<query driver="mysql">
			ALTER TABLE papers ADD COLUMN comments_status TINYINT NOT NULL DEFAULT 0
		</query>

		<!-- Syntax for PostgreSQL. -->
		<query driver="postgres7">
			ALTER TABLE tracks ADD COLUMN disable_comments SMALLINT NOT NULL DEFAULT 0
		</query>
		<query driver="postgres7">
			ALTER TABLE papers ADD COLUMN comments_status SMALLINT NOT NULL DEFAULT 0
		</query>
	</sql>
</data>
